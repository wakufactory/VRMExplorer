<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width">
<title>VRM Explorer</title>
<script type="text/javascript" src=""></script>
<script type="text/javascript">
"use strict" ;
function $(e) {return document.getElementById(e)}
document.addEventListener("DOMContentLoaded",function() {
	$('f').addEventListener("change", (ev)=>{
			const reader = new FileReader();
			reader.onload = (ev) =>{
				const vrm = new VRM() 
				if(vrm.parse(reader.result)) {
					$('imgs').innerHTML = "" ;
					for(let j in vrm.meta) {
						const t = document.createElement("h2")
						t.innerHTML =  j 
						const i = document.createElement("textarea")
						if(Array.isArray(vrm.meta[j])) {
							const a = [] 
							t.innerHTML += `(${vrm.meta[j].length})`
							for(let i=0;i<vrm.meta[j].length;i++) {
								a.push(`<${i}>\n${JSON.stringify(vrm.meta[j][i],null,"    ")}`)
							}
							i.value = a.join("\n")
						} else 
							i.value = JSON.stringify(vrm.meta[j],null,"    ")
						$('jlist').appendChild(t)
						
						$('jlist').appendChild(i)
					}
					const imgs = vrm.getimg()
					for(let im of imgs) {
						const img = document.createElement("img");
						img.src= im
						$('imgs').appendChild(img)
					}
				}
			}
			reader.readAsArrayBuffer(ev.target.files[0]);
	})
})
const VRM = function() {
	this.bsize = 0 
	this.meta = null
} 
VRM.prototype.parse = function(abuf){
	function u4(ofs) {return buf[ofs]+256*(buf[ofs+1]+256*(buf[ofs+2]+256*buf[ofs+3])) }
	const buf = new Uint8Array(abuf)
	if(buf[0]!=0x67||buf[1]!=0x6c||buf[2]!=0x54||buf[3]!=0x46||buf[4]!=2) return null
	this.bsize = u4(8)
	console.log(this.bsize)  
	let ofs = 12
	const chunk = [] ;
	while(ofs<this.bsize) {
		const csize = u4(ofs)
		let ctype = u4(ofs+4)
		if(ctype==1313821514) ctype="JSON"
		if(ctype==5130562) ctype="BIN"
		if(ctype=="JSON") {
			let js =Array.from(buf.slice(ofs+8,csize+ofs+8), e => String.fromCharCode(e)).join("")
			this.meta = JSON.parse(js)
			chunk.push({type:ctype,ofs:ofs,size:csize,data:this.meta})
		}
		if(ctype=="BIN") {
			this.bin = buf.slice(ofs+8,csize+ofs+8)
			chunk.push({type:ctype,ofs:ofs,size:csize,data:this.bin})	
		}
		ofs += 8+csize 
	}
	this.chunk = chunk 
	console.log(chunk)
	return chunk 
}
VRM.prototype.getimg = function(){
	const imgs = [] 
	for(let im of this.meta.images) {
		const buf = this.meta.bufferViews[im.bufferView] 
		const data = this.bin.slice(buf.byteOffset,buf.byteOffset+buf.byteLength)
		const uri = "data:"+im.mimeType+";base64,"+btoa(Array.from(data,e=>String.fromCharCode(e)).join(""))
		imgs.push(uri)
	}
	return imgs 
}
</script>
<link rel="stylesheet" type="text/css" href="">
<style type="text/css">
div.cont {
	display:flex ;
}
div.json {
	width:50vw ;
}
div.json textarea {
	width:49vw ;
	height:10vh ;
	font-size:1rem ;
}
#imgs img {
	width:200px ;
}
#jlist h2 {
	margin:0 ;
	font-size:1.2rem ;
	font-weight:bold ;
}
</style>
</head>
<body>
<input id=f type=file accept=".vrm,.glb">
<div class=cont>
<div id=jlist class=json>

</div>
<div class=img>
<div id=imgs></div>
</div>
</div>
</body>
</html>